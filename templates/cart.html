{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="mb-4 text-center">ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h1>

    <div class="row mb-3">
        <div class="col-md-12 d-flex justify-content-between">
            <button class="btn btn-danger" onclick="clearCart()">ğŸ—‘ï¸ Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</button>
            <button class="btn btn-success" onclick="checkout()">ğŸ’³ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</button>
            <a href="{% url 'orders_view' %}" class="btn btn-info">ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†</a>
        </div>
    </div>

    <div id="cart-items" class="row g-3">
        <!-- Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø± Ù…ÛŒØ´Ù† -->
    </div>
</div>

<script>
const API_CART = "http://localhost:8000/api/cart/";
const API_ORDER = "http://localhost:8000/api/orders/checkout/";

// ğŸŸ¢ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„
function addToCart(productId) {
    fetch(API_CART + "add_item/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: 1
        })
    })
    .then(res => res.json())
    .then(data => {
        alert("âœ… Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!");
        loadCart();
    })
    .catch(err => alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„!"));
}

// ğŸ”´ Ø­Ø°Ù ÛŒÚ© Ù…Ø­ØµÙˆÙ„
function removeFromCart(productId) {
    fetch(API_CART + "remove_item/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(res => res.json())
    .then(data => {
        alert("ğŸ—‘ï¸ Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´Ø¯!");
        loadCart();
    })
    .catch(err => alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„!"));
}

// ğŸŸ¡ Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯
function clearCart() {
    fetch(API_CART + "clear_cart/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        alert("ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø´Ø¯!");
        loadCart();
    })
    .catch(err => alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯!"));
}

// ğŸ’³ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨
function checkout() {
    fetch(API_ORDER, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => {
        if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨");
        return res.json();
    })
    .then(data => {
        alert("âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯! Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: " + data.id);
        loadCart();
    })
    .catch(err => alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´!"));
}

// ğŸ“¦ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
function loadCart() {
    fetch(API_CART, {
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById("cart-items");
        container.innerHTML = "";
        if (data.items && data.items.length > 0) {
            data.items.forEach(item => {
                container.innerHTML += `
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm">
                            <h5>${item.product.name}</h5>
                            <p>ØªØ¹Ø¯Ø§Ø¯: ${item.quantity}</p>
                            <p>Ù‚ÛŒÙ…Øª: ${item.product.price} ØªÙˆÙ…Ø§Ù†</p>
                            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.product.id})">âŒ Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            });
        } else {
            container.innerHTML = "<p class='text-center'>ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>";
        }
    });
}

// ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ø´Ø¯ â†’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø±Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
document.addEventListener("DOMContentLoaded", loadCart);
</script>
{% csrf_token% }
<script>
function getCookie(name) {
    let cookieValue=null;
    if(document.cookie && document.cookie !== '') {
        const cookie = document.cookie.split(';');
        for(let i=0; i<cookies.length; i++) {
            const cookie =cookies[i].trim();
            if (cookie.substring(name.length +1)===(name +'=')){
                cookieValue= decodeURIComponent(cookie.substring(name.length +1));
                break;

            }
        }
    }
    return cookieValue;
}
const csrftoken=getCookie("csrftoken");
</script>
</body>
</html>

