{% comment %} {% comment %} {% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>سبد خرید</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
</head>
<body dir="rtl" class="p-4 bg-light">

    <div class="container">
        <h2 class="text-center mb-4">🛍️ سبد خرید شما</h2>
        <div id="cart-items" class="row"></div>

        <div class="text-center mt-4">
            <button class="btn btn-danger" onclick="clearCart()">🗑️ خالی کردن سبد</button>
            <button class="btn btn-success" onclick="checkout()">✅ ثبت سفارش</button>
        </div>
    </div>

    <script>
        // ------------------ CSRF Helper ------------------
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // ------------------ Base URLs ------------------
        let BASE_URL = "http://127.0.0.1:8000";
        const API_CART = BASE_URL + "/api/cart/";
        const API_ORDER = BASE_URL + "/api/orders/";

        // ------------------ Load Cart ------------------
        function loadCart() {
            fetch(API_CART)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById("cart-items");
                    container.innerHTML = "";

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            container.innerHTML += `
                                <div class="col-md-4 mb-3">
                                    <div class="card p-3 shadow-sm">
                                        <h5>${item.product.name}</h5>
                                        <p>تعداد: ${item.quantity}</p>
                                        <p>قیمت: ${item.product.price} تومان</p>
                                        <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.product.id})">حذف</button>
                                    </div>
                                </div>`;
                        });
                    } else {
                        container.innerHTML = "<p class='text-center w-100'>🛍️ سبد خرید شما خالی است.</p>";
                    }
                });
        }

        // ------------------ Add Item ------------------
        function addToCart(productId) {
            fetch(API_CART + "add_item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            })
            .then(res => {
                if (!res.ok) throw new Error("خطا در افزودن محصول");
                return res.json();
            })
            .then(data => {
                alert("✅ محصول اضافه شد به سبد!");
                loadCart();
            })
            .catch(err => alert("❌ " + err.message));
        }

        // ------------------ Remove Item ------------------
        function removeFromCart(productId) {
            fetch(API_CART + "remove_item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ product_id: productId })
            })
            .then(res => res.json())
            .then(data => {
                alert("🗑️ محصول حذف شد!");
                loadCart();
            });
        }

        // ------------------ Clear Cart ------------------
        function clearCart() {
            fetch(API_CART + "clear_cart/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert("🧹 سبد خرید خالی شد!");
                loadCart();
            });
        }

        // ------------------ Checkout ------------------
        function checkout() {
            fetch(API_ORDER + "checkout/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert("✅ سفارش ثبت شد!");
                loadCart();
            });
        }

        // ------------------ Init ------------------
        document.addEventListener("DOMContentLoaded", loadCart);
    </script>

</body>
{% comment %} </html> {% endcomment %}



<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>سبد خرید شما</title>
    <style>
        body {
            font-family: "Vazir", sans-serif;
            background-color: #f4f4f4;
            padding: 40px;
            direction: rtl;
        }
        h2 {
            text-align: center;
        }
        table {
            width: 70%;
            margin: 0 auto;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px #ccc;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #28a745;
            color: white;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            display: inline-block;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .total {
            text-align: center;
            margin-top: 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h2>🛒 سبد خرید شما</h2>

    {% if items %}
    <table>
        <tr>
            <th>محصول</th>
            <th>تعداد</th>
            <th>قیمت</th>
            <th>جمع</th>
        </tr>
        {% for item in items %}
        <tr>
            <td>{{ item.product.name }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.product.price }} تومان</td>
            <td>{{ item.total }} تومان</td>
        </tr>
        {% endfor %}
    </table>

    <div class="total">
        <p><strong>مجموع کل:</strong> {{ total_amount }} تومان</p>
        {% comment %} <form action="{% url 'payment_start' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn">💳 پرداخت</button>
        </form> {% endcomment %}
        {% comment %} <a href="/api/payments/start/" class="btn">پرداخت</a> {% endcomment %}
        <a href="{%url 'payment_start'%}" class="btn">پرداخت</a>
    </div>
    {% else %}
    <p style="text-align:center;">سبد خرید شما خالی است.</p>
    {% endif %}
</body>
</html>
