{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>سبد خرید</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
</head>
<body dir="rtl" class="p-4 bg-light">

    <div class="container">
        <h2 class="text-center mb-4">🛍️ سبد خرید شما</h2>
        <div id="cart-items" class="row"></div>

        <div class="text-center mt-4">
            <button class="btn btn-danger" onclick="clearCart()">🗑️ خالی کردن سبد</button>
            <button class="btn btn-success" onclick="checkout()">✅ ثبت سفارش</button>
        </div>
    </div>

    <script>
        // ------------------ CSRF Helper ------------------
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // ------------------ Base URLs ------------------
        let BASE_URL = "http://127.0.0.1:8000";
        const API_CART = BASE_URL + "/api/cart/";
        const API_ORDER = BASE_URL + "/api/orders/";

        // ------------------ Load Cart ------------------
        function loadCart() {
            fetch(API_CART)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById("cart-items");
                    container.innerHTML = "";

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            container.innerHTML += `
                                <div class="col-md-4 mb-3">
                                    <div class="card p-3 shadow-sm">
                                        <h5>${item.product.name}</h5>
                                        <p>تعداد: ${item.quantity}</p>
                                        <p>قیمت: ${item.product.price} تومان</p>
                                        <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.product.id})">حذف</button>
                                    </div>
                                </div>`;
                        });
                    } else {
                        container.innerHTML = "<p class='text-center w-100'>🛍️ سبد خرید شما خالی است.</p>";
                    }
                });
        }

        // ------------------ Add Item ------------------
        function addToCart(productId) {
            fetch(API_CART + "add_item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ product_id: productId, quantity: 1 })
            })
            .then(res => {
                if (!res.ok) throw new Error("خطا در افزودن محصول");
                return res.json();
            })
            .then(data => {
                alert("✅ محصول اضافه شد به سبد!");
                loadCart();
            })
            .catch(err => alert("❌ " + err.message));
        }

        // ------------------ Remove Item ------------------
        function removeFromCart(productId) {
            fetch(API_CART + "remove_item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ product_id: productId })
            })
            .then(res => res.json())
            .then(data => {
                alert("🗑️ محصول حذف شد!");
                loadCart();
            });
        }

        // ------------------ Clear Cart ------------------
        function clearCart() {
            fetch(API_CART + "clear_cart/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert("🧹 سبد خرید خالی شد!");
                loadCart();
            });
        }

        // ------------------ Checkout ------------------
        function checkout() {
            fetch(API_ORDER + "checkout/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert("✅ سفارش ثبت شد!");
                loadCart();
            });
        }

        // ------------------ Init ------------------
        document.addEventListener("DOMContentLoaded", loadCart);
    </script>

</body>
</html>
